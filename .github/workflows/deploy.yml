---
name: üöÄ CI - Deploy
on:
  workflow_dispatch:
jobs:
  deploy:
    name: üöÄ Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Rebase
        uses: cyberskill-world/.github/actions/rebase@main
        with:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          FROM: main
          TO: release

      - name: Env & Deps
        uses: cyberskill-world/.github/actions/env-deps@main

      - name: Install semantic-release globally
        run: |
          pnpm install --global semantic-release@latest @semantic-release/git@latest

      - name: Build
        uses: cyberskill-world/.github/actions/build@main

      - name: Resolve Zombie Tag Conflict
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "üîÆ Calculating next version..."

          DRY_RUN_OUTPUT=$(semantic-release --dry-run --branches release 2>&1 || true)

          echo "--- Dry Run Output ---"
          echo "$DRY_RUN_OUTPUT"
          echo "----------------------"

          NEXT_VERSION=$(echo "$DRY_RUN_OUTPUT" | grep -oP "The next release version is \K[0-9]+\.[0-9]+\.[0-9]+" || true)

          if [ -z "$NEXT_VERSION" ]; then
            echo "‚úÖ No release scheduled or version could not be parsed. Proceeding..."
          else
            echo "üéØ Targeted version: v$NEXT_VERSION"

            if git ls-remote --exit-code --tags origin "v$NEXT_VERSION" >/dev/null 2>&1; then
              echo "‚ö†Ô∏è Tag v$NEXT_VERSION exists! Forcing a jump to the next patch version..."

              git fetch --tags
              git config user.name "github-actions[bot]"
              git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

              git commit --allow-empty -m "feat: bump version to resolve tag conflict with v$NEXT_VERSION"

              git push origin HEAD:release

              echo "üöÄ Created and pushed empty commit to force version bump."
            else
              echo "‚úÖ Tag is free. Proceeding..."
            fi
          fi

      - name: Deploy
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: semantic-release

      - name: Create PR to main
        uses: cyberskill-world/.github/actions/create-pr@main
        with:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          FROM: release
          TO: main
