#!/usr/bin/env node
function n(n,t,e,r,i,c,s){try{var o=n[c](s);var a=o.value}catch(n){e(n);return}if(o.done){t(a)}else{Promise.resolve(a).then(r,i)}}function t(t){return function(){var e=this,r=arguments;return new Promise(function(i,c){var s=t.apply(e,r);function o(t){n(s,i,c,o,a,"next",t)}function a(t){n(s,i,c,o,a,"throw",t)}o(undefined)})}}function e(n,t,e){if(t in n){Object.defineProperty(n,t,{value:e,enumerable:true,configurable:true,writable:true})}else{n[t]=e}return n}function r(n){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};var i=Object.keys(r);if(typeof Object.getOwnPropertySymbols==="function"){i=i.concat(Object.getOwnPropertySymbols(r).filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable}))}i.forEach(function(t){e(n,t,r[t])})}return n}function i(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);if(t){r=r.filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable})}e.push.apply(e,r)}return e}function c(n,t){t=t!=null?t:{};if(Object.getOwnPropertyDescriptors){Object.defineProperties(n,Object.getOwnPropertyDescriptors(t))}else{i(Object(t)).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))})}return n}function s(n,t){var e,r,i,c,s={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]};return c={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol==="function"&&(c[Symbol.iterator]=function(){return this}),c;function o(n){return function(t){return a([n,t])}}function a(c){if(e)throw new TypeError("Generator is already executing.");while(s)try{if(e=1,r&&(i=c[0]&2?r["return"]:c[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;if(r=0,i)c=[c[0]&2,i.value];switch(c[0]){case 0:case 1:i=c;break;case 4:s.label++;return{value:c[1],done:false};case 5:s.label++;r=c[1];c=[0];continue;case 7:c=s.ops.pop();s.trys.pop();continue;default:if(!(i=s.trys,i=i.length>0&&i[i.length-1])&&(c[0]===6||c[0]===2)){s=0;continue}if(c[0]===3&&(!i||c[1]>i[0]&&c[1]<i[3])){s.label=c[1];break}if(c[0]===6&&s.label<i[1]){s.label=i[1];i=c;break}if(i&&s.label<i[2]){s.label=i[2];s.ops.push(c);break}if(i[2])s.ops.pop();s.trys.pop();continue}c=t.call(n,s)}catch(n){c=[6,n];r=0}finally{e=i=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:true}}}import o from"boxen";import a from"chalk";import u from"node-fetch";import{exec as l}from"node:child_process";import*as f from"node:fs";import*as p from"node:path";import h from"node:process";import*as g from"node:util";import m from"ora";import{hideBin as d}from"yargs/helpers";import y from"yargs/yargs";import{dirname as _}from"node:path";import{fileURLToPath as b}from"node:url";var v=b(import.meta.url),w=_(v);var I=a.blue,S=a.red,T=a.yellow,O=a.green,P=a.gray,E=a.white,N=a.bold,x=g.promisify(l),C={FILE_EXTENSIONS:"**/*.{ts,tsx,js,jsx,json,css,scss,less}",INIT_CWD:h.env.INIT_CWD||h.cwd(),TSCONFIG_PATH:"".concat(h.env.INIT_CWD||h.cwd(),"/tsconfig.json"),HUSKY_PATH:"".concat(h.env.INIT_CWD||h.cwd(),"/.husky"),GIT_HOOK_PATH:"".concat(h.env.INIT_CWD||h.cwd(),"/.git/hooks"),GIT_COMMIT_MSG:"".concat(h.env.INIT_CWD||h.cwd(),"/.git/COMMIT_EDITMSG"),SIMPLE_GIT_HOOKS_PATH:"".concat(h.env.INIT_CWD||h.cwd(),"/.simple-git-hooks.json"),PACKAGE_NAME:"@cyberskill/shared"},k=[];function j(n){return m({text:n,color:"cyan",spinner:"dots"})}function R(n){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";var e=new Date().toLocaleString();console.log("".concat(t," [").concat(e,"] ").concat(E(n)))}function A(n,t){return D.apply(this,arguments)}function D(){D=t(function(n,t){var e,r,i,c,o,a,u,l,f;var p=arguments;return s(this,function(s){switch(s.label){case 0:e=p.length>2&&p[2]!==void 0?p[2]:H;R(t);r=new AbortController;h.on("SIGINT",function(){console.log("Terminating process..."),r.abort(),h.exit()});s.label=1;case 1:s.trys.push([1,3,,4]);return[4,x(n,{maxBuffer:0x6400000,signal:r.signal})];case 2:i=s.sent(),c=i.stdout,o=i.stderr;[c,o].forEach(function(n){return n&&e(n)});return[3,4];case 3:a=s.sent();u=a.stdout,l=a.stderr,f=a.message;[u,l].forEach(function(n){return n&&e(n)}),!l&&!u&&console.error("Command failed: ".concat(f));return[3,4];case 4:return[2]}})});return D.apply(this,arguments)}function W(n,t){return G.apply(this,arguments)}function G(){G=t(function(n,t){var e,r;return s(this,function(i){switch(i.label){case 0:e=j(n).start();i.label=1;case 1:i.trys.push([1,3,,4]);return[4,t()];case 2:i.sent(),k.length?h.exit(1):e.succeed("".concat(n," completed successfully!"));return[3,4];case 3:r=i.sent();throw e.fail("".concat(n," failed.")),r;case 4:return[2]}})});return G.apply(this,arguments)}function H(n){try{JSON.parse(n).forEach(function(n){var t=n.filePath,e=n.messages;e.forEach(function(n){var e=n.severity,r=n.line,i=n.column,c=n.ruleId,s=n.message;k.push({type:e===2?"error":"warning",file:t,position:"".concat(r,":").concat(i),rule:c,message:s})})})}catch(t){M(n)}}function M(n){var t=/^\s*(\d+):(\d+)\s+(error|warning)\s+(\S+)\s+(\S+)$/,e=/^(.+?)\((\d+),(\d+)\):\s+(error|warning)\s+TS\d+:\s+(\S.+)$/,r=/^✖\s+(.*?)\s+\[(.*?)\]$/,i=[],c="";n.split("\n").forEach(function(n){if(n.startsWith("/"))c=n.trim();else{var s=t.exec(n);if(s&&c)k.push({file:c,position:"".concat(s[1],":").concat(s[2]),type:s[3]==="error"?"error":"warning",message:s[4].trim(),rule:s[5].trim()});else{var o=e.exec(n);if(o)k.push({file:o[1],position:"".concat(o[2],":").concat(o[3]),type:o[4],message:o[5].trim()});else{var a=r.exec(n);a?k.push({file:"commitlint",type:"error",message:a[1].trim(),rule:a[2].trim()}):i.push(n.trim())}}}}),i.length>0&&(console.log(P("Unmatched lines:")),i.forEach(function(n){return console.info(n)}))}function U(n,t){var e=new Map([[S,"red"],[T,"yellow"],[O,"green"]]).get(t)||"green";return o(N(t(n)),{padding:1,margin:1,borderStyle:"arrow",borderColor:e})}function F(n,t,e,r){n.length&&(n.forEach(function(n){var r=n.file,i=n.position,c=n.rule,s=n.message;console.log("".concat(t("".concat(e," File:"))," ").concat(I("".concat(r).concat(i?":".concat(i):"")))),c&&console.log("   ".concat(t("Rule:")," ").concat(t(c))),console.log("   ".concat(t("Message:")," ").concat(t(s)))}),console.log(U(N(t("".concat(e," Total ").concat(r,": ").concat(n.length))),t)),console.log(P("─".repeat(40))))}function K(){var n=k.filter(function(n){return n.type==="error"}),t=k.filter(function(n){return n.type==="warning"});!n.length&&!t.length?console.log(U(N(O("✔ NO ISSUE FOUND!")),O)):(F(t,T,"⚠","Warnings"),F(n,S,"✖","Errors"))}function L(){return J.apply(this,arguments)}function J(){J=t(function(){var n;return s(this,function(t){switch(t.label){case 0:if(!f.existsSync(C.TSCONFIG_PATH))return[3,2];return[4,A("npx tsc -p ".concat(C.TSCONFIG_PATH," --noEmit"),"TypeScript checking...")];case 1:n=t.sent();return[3,3];case 2:n=R("tsconfig.json file not found.","⚠️");t.label=3;case 3:n;return[2]}})});return J.apply(this,arguments)}function Y(){return $.apply(this,arguments)}function $(){$=t(function(){var n,t;var e=arguments;return s(this,function(r){switch(r.label){case 0:n=e.length>0&&e[0]!==void 0?e[0]:!1;t="npx eslint ".concat(C.INIT_CWD).concat(n?" --fix":" --format json");return[4,A(t,"Eslint ".concat(n?"fixing":"checking","..."))];case 1:r.sent();return[2]}})});return $.apply(this,arguments)}function B(){return X.apply(this,arguments)}function X(){X=t(function(){return s(this,function(n){switch(n.label){case 0:return[4,A('npx lint-staged -- "*": "eslint --fix"',"Lint-staged processing...")];case 1:n.sent();return[2]}})});return X.apply(this,arguments)}function q(){return z.apply(this,arguments)}function z(){z=t(function(){return s(this,function(n){switch(n.label){case 0:R("Starting lint check for ".concat(C.INIT_CWD),"\uD83D\uDE80");return[4,W("Running lint checks...",/*#__PURE__*/t(function(){return s(this,function(n){switch(n.label){case 0:k.length=0;return[4,Promise.all([L(),Y()])];case 1:n.sent(),K();return[2]}})}))];case 1:n.sent();return[2]}})});return z.apply(this,arguments)}function Q(){return V.apply(this,arguments)}function V(){V=t(function(){return s(this,function(n){switch(n.label){case 0:R("Starting lint and format fix for ".concat(C.INIT_CWD),"\uD83D\uDE80");return[4,W("Fixing issues...",/*#__PURE__*/t(function(){return s(this,function(n){switch(n.label){case 0:return[4,Y(!0)];case 1:n.sent();return[2]}})}))];case 1:n.sent();return[2]}})});return V.apply(this,arguments)}function Z(){return nn.apply(this,arguments)}function nn(){nn=t(function(){return s(this,function(n){switch(n.label){case 0:return[4,A("npx @eslint/config-inspector","Lint inspect processing...")];case 1:n.sent();return[2]}})});return nn.apply(this,arguments)}function nt(){return ne.apply(this,arguments)}function ne(){ne=t(function(){return s(this,function(n){switch(n.label){case 0:R("Starting lint-staged process for ".concat(h.env.INIT_CWD),"\uD83D\uDE80");return[4,W("Running lint-staged...",/*#__PURE__*/t(function(){return s(this,function(n){switch(n.label){case 0:k.length=0;return[4,Promise.all([L(),B()])];case 1:n.sent(),K();return[2]}})}))];case 1:n.sent();return[2]}})});return ne.apply(this,arguments)}function nr(){return ni.apply(this,arguments)}function ni(){ni=t(function(){return s(this,function(n){switch(n.label){case 0:R("Starting commitlint process for ".concat(C.INIT_CWD),"\uD83D\uDE80");return[4,W("Running commitlint...",/*#__PURE__*/t(function(){var n,t;return s(this,function(e){switch(e.label){case 0:k.length=0;n=p.resolve(w,"./configs/commitlint/commitlint.base.js"),t="npx --no -- commitlint --edit ".concat(C.GIT_COMMIT_MSG," --config ").concat(n);return[4,A(t,"Commitlint processing...")];case 1:e.sent(),K();return[2]}})}))];case 1:n.sent();return[2]}})});return ni.apply(this,arguments)}function nc(){return ns.apply(this,arguments)}function ns(){ns=t(function(){var n;return s(this,function(t){switch(t.label){case 0:n=f.existsSync(C.HUSKY_PATH);if(!n)return[3,2];return[4,A("npx rimraf ".concat(C.HUSKY_PATH," ").concat(C.GIT_HOOK_PATH," && git config core.hooksPath ").concat(C.GIT_HOOK_PATH),"Removing husky hooks...")];case 1:n=t.sent();t.label=2;case 2:n,f.writeFileSync(C.SIMPLE_GIT_HOOKS_PATH,JSON.stringify({"pre-commit":"npx --yes cyberskill lint-staged","commit-msg":"npx --yes cyberskill commitlint"},null,4));return[4,A("npx simple-git-hooks","Setting up git hooks...")];case 3:t.sent(),f.unlinkSync(C.SIMPLE_GIT_HOOKS_PATH);return[2]}})});return ns.apply(this,arguments)}function no(){return na.apply(this,arguments)}function na(){na=t(function(){return s(this,function(n){switch(n.label){case 0:R("Starting setup process for ".concat(C.INIT_CWD),"\uD83D\uDE80");return[4,W("Setting up...",/*#__PURE__*/t(function(){var n,i,o,a,l,p,h,g,m;return s(this,function(d){switch(d.label){case 0:i="".concat(C.INIT_CWD,"/package.json"),o=/*#__PURE__*/function(){var n=t(function(){return s(this,function(n){switch(n.label){case 0:return[4,u("https://registry.npmjs.org/".concat(C.PACKAGE_NAME,"/latest"))];case 1:return[4,n.sent().json()];case 2:return[2,n.sent().version]}})});return function t(){return n.apply(this,arguments)}}(),a=/*#__PURE__*/function(){var n=t(function(){var n,t,e,r;return s(this,function(i){switch(i.label){case 0:return[4,o()];case 1:n=i.sent();try{t="".concat(C.INIT_CWD,"/node_modules/").concat(C.PACKAGE_NAME,"/package.json"),e=JSON.parse(f.readFileSync(t,"utf-8")),r=e.version;return[2,r!==n]}catch(n){return[2,!0]}return[2]}})});return function t(){return n.apply(this,arguments)}}(),l=/*#__PURE__*/function(){var n=t(function(){var n,t;return s(this,function(s){switch(s.label){case 0:return[4,o()];case 1:n=s.sent(),t=JSON.parse(f.readFileSync(i,"utf-8"));t.dependencies=c(r({},t.dependencies),e({},C.PACKAGE_NAME,n)),f.writeFileSync(i,JSON.stringify(t,null,2));return[4,A("npm i -f","Installing all dependencies with updated cyberskill...")];case 2:s.sent();return[4,A("npm run lint:fix","Fixing lint issues...")];case 3:s.sent();return[2]}})});return function t(){return n.apply(this,arguments)}}(),p=JSON.parse(f.readFileSync(i,"utf-8"));if(!(p.name===C.PACKAGE_NAME))return[3,1];h=R("Cyberskill is the current project. No setup needed.","✅");return[3,7];case 1:m=!((n=p.dependencies)===null||n===void 0?void 0:n.cyberskill);if(m)return[3,3];return[4,a()];case 2:m=d.sent();d.label=3;case 3:if(!m)return[3,5];R("Cyberskill is missing or outdated. Updating...");return[4,l()];case 4:g=d.sent();return[3,6];case 5:g=R("Cyberskill is up to date","✅");d.label=6;case 6:h=g;d.label=7;case 7:h,nc();return[2]}})}))];case 1:n.sent();return[2]}})});return na.apply(this,arguments)}function nu(){return nl.apply(this,arguments)}function nl(){nl=t(function(){return s(this,function(n){switch(n.label){case 0:R("Starting reset process for ".concat(C.INIT_CWD),"\uD83D\uDE80");return[4,W("Resetting...",/*#__PURE__*/t(function(){return s(this,function(n){switch(n.label){case 0:return[4,A("npx rimraf ".concat(C.INIT_CWD,"/node_modules ").concat(C.INIT_CWD,"/package-lock.json"),"Cleaning node_modules and package-lock.json...")];case 1:n.sent();return[4,A("npm i -f","Installing all dependencies...")];case 2:n.sent(),nc();return[2]}})}))];case 1:n.sent();return[2]}})});return nl.apply(this,arguments)}function nf(){return np.apply(this,arguments)}function np(){np=t(function(){var n;return s(this,function(e){switch(e.label){case 0:n=p.resolve(w,"./configs/vitest/react/unit.js");R("Starting unit tests for ".concat(C.INIT_CWD),"\uD83D\uDE80");return[4,W("Running unit tests...",/*#__PURE__*/t(function(){return s(this,function(t){switch(t.label){case 0:return[4,A("npx vitest --config ".concat(n),"Running unit tests...")];case 1:t.sent();return[2]}})}))];case 1:e.sent();return[2]}})});return np.apply(this,arguments)}function nh(){return ng.apply(this,arguments)}function ng(){ng=t(function(){var n;return s(this,function(e){switch(e.label){case 0:n=p.resolve(w,"./configs/vitest/react/e2e.js");R("Starting e2e tests for ".concat(C.INIT_CWD),"\uD83D\uDE80");return[4,W("Running end-to-end tests...",/*#__PURE__*/t(function(){return s(this,function(t){switch(t.label){case 0:return[4,A("npx vitest --config ".concat(n),"Running e2e tests...")];case 1:t.sent();return[2]}})}))];case 1:e.sent();return[2]}})});return ng.apply(this,arguments)}y(d(h.argv)).command("lint","Run linting checks",q).command("lint:fix","Fix linting and formatting issues",Q).command("lint:inspect","Inspect linting rules",Z).command("lint-staged","Run lint-staged with given configuration",nt).command("commitlint","Run commitlint with given configuration",nr).command("setup","Run setup with given configuration",no).command("reset","Reset dependencies and install",nu).command("test:unit","Run unit tests",nf).command("test:e2e","Run e2e tests",nh).help().parse();